<!doctype html><body>
<script src="../then.js"></script>
<script src="../fonts.js"></script>
<script src="../glyphs.js"></script>
<style>
#IO { float:right; }
#IO .col { float:left; margin-left:10px; }
#IO label { display:block; }

input[type=number] { width:60px; }
#char { width:60px; }
#font { width:120px; }
</style>
<canvas></canvas>
<br />

<div id="IO">
	<div class="col">
		<label for="input">INPUT:</label>
		<textarea id="input"></textarea>
	</div>
	<div class="col">
		<label for="output">OUTPUT:</label>
		<textarea id="output"></textarea>
	</div>
</div>
<form>
	<label for="zoom">Zoom: </label><input id="zoom" type="range" step="0.1" value="2" min="1" max="10" />
	<br />
	<label for="char">Character: </label><input id="char" value="?" />
	(<label for="as_text">as text? </label><input id="as_text" type="checkbox" />)
	<label for="font">Font: </label><input id="font" value="48px Arial" />
	<label for="radius">Radius: </label><input id="radius" type="number" value="40" min="0.01" step="0.1" />px
	<label for="colour">Colour: </label><input id="colour" type="color" value="#000000" />
	<br />
	<label for="rotation">Rotation: </label><input id="rotation" type="number" value="0" />&deg;
	Scale: (<label for="scale_x">x: </label><input id="scale_x" type="number" value="1" min="0.01" step="0.1" />%, <label for="scale_y">y: </label><input id="scale_y" type="number" value="1" min="0.01" step="0.1" />%)
	Centre: (<label for="centre_x">x: </label><input id="centre_x" type="number" value="0" step="0.1" />px, <label for="centre_y">y: </label><input id="centre_y" type="number" value="0" step="0.1" />px <input type="button" id="guess" value="Guess" />)

	<br />

	<input type="reset" />
</form>

<script>

document.forms[0].onreset = function() {
	setTimeout(render, 0);
};

document.querySelectorAll("input:not([type=button])").forEach(function(i) {
	i.onchange = i.onkeyup = i.oninput = render;
});
guess.onclick = function(e) {
	centre_y.value = 0;
	ctx.save(); {
		ctx.font = font.value;
		centre_x.value = ctx.measureText(char.value).width / 2;
	} ctx.restore();
	render();
	e.preventDefault();
};

input.onpaste = function() {
	setTimeout(function() {
		try {
			from_input(input.value);
		} catch(e) {
			prompt("Please copy the following into an email and send it to the developer.", e.message+"\n"+e.stack);
			input.value = "ERROR";
			return;
		}
		input.value = "UPDATED";
	}, 0);
}
input.onclick = output.onclick = function() { this.select(); }
function from_input(value) {
	var p = JSON.parse("[" + value + "]");
	char.value = p[0];
	as_text.checked = [1];
	font.value = p[2];
	centre_x.value = p[3].x;
	centre_y.value = p[3].y;
	radius.value = p[4];
	colour.value = p[5];
	rotation.value = p[6];
	scale_x.value = p[7];
	scale_y.value = p[8];
	
	render();
}


var canvas = document.querySelector("canvas"), ctx = canvas.getContext("2d");
var click = document.createElement("CANVAS"), cctx = click.getContext("2d");
var ui = document.createElement("CANVAS"), uictx = ui.getContext("2d");
document.body.appendChild(ui);

document.body.appendChild(click);

ui.onmousedown = function(e) {
	e.preventDefault();
	
	window.onmousemove = function() {
		
	};
	window.onmouseup = function() {
		window.onmousemove = window.onmouseup = null;
	};
};

var g, load_glyphs = glyphs();
function load_glyph(then) {
	g = load_glyphs.add(
		char.value, as_text.checked, font.value, { x: centre_x.valueAsNumber, y: centre_y.valueAsNumber }, radius.valueAsNumber, colour.value, rotation.valueAsNumber, scale_x.valueAsNumber, scale_y.valueAsNumber
	);
	load_glyphs.then(then);
}

function render() {
	load_glyph(function() {
		var s = zoom.valueAsNumber, size = 200, pad = 10;
		var ss = (size * s);
		cs = canvas.width = canvas.height = pad + ss + pad;
		
		click.width = click.height = cs;
		cctx.arc(pad + (ss / 2), pad + (ss / 2), ss / 2, 0, Math.PI * 2, true);
		cctx.lineWidth = 5; cctx.stroke();
		
		ctx.beginPath();
		ctx.arc(pad + (ss / 2), pad + (ss / 2), ss / 2, 0, Math.PI * 2, true);
		ctx.moveTo(0, 0); ctx.rect(-50, -50, pad + cs + pad + 50, pad + cs + pad + 50);
		ctx.fill();

		ctx.lineWidth = 1.5;
		ctx.beginPath();
		ctx.moveTo(0, pad + (ss / 2)); ctx.lineTo(pad + ss, pad + (ss / 2));
		ctx.moveTo(pad + (ss / 2), 0); ctx.lineTo(pad + (ss / 2), pad + ss);
		ctx.stroke();
		
		ctx.globalCompositeOperation = "xor";
		
		var centre = (pad / s) + (ss / 2);
		g.render(ctx, centre, centre, ss / 2);

		var r = JSON.stringify([
			char.value, as_text.checked, font.value, { x: centre_x.valueAsNumber, y: centre_y.valueAsNumber }, radius.valueAsNumber, colour.value, rotation.valueAsNumber, scale_x.valueAsNumber, scale_y.valueAsNumber
		]);
		r = r.substr(1, r.length - 2);
		output.value = r;
	});
}
from_input('"?",true,"48px Arial",{"x":13.1,"y":-2.3},18.5,"#26b423",30,1.41,1');
render();

var show_radius = true;
function render_ui() {
	load_glyphs.then(function() {
		uictx.font = font.value;
		var size = uictx.measureText(char.value).width * 2;
		var scale = zoom.valueAsNumber;
		ui.width = ui.height = size * scale;
		
		if (show_radius) {
			uictx.beginPath();
			uictx.save(); {
				uictx.arc(centre_x.valueAsNumber, centre_y.valueAsNumber, radius.valueAsNumber, 0, Math.PI * 2, true);
				uictx.strokeStyle = "green"; uictx.lineWidth = 5; uictx.stroke();
			} uictx.restore();
		}
	});
}
render_ui();

</script>
<script src="http://localhost:35729/livereload.js"></script>