<!doctype html>
<script src="then.js"></script>
<script src="make_canvas.js"></script>
<script src="simple_transform.js"></script>
<script src="images.js"></script>
<script src="fonts.js"></script>
<script src="colour.js"></script>
<script src="glyphs.js"></script>
<style>
	canvas { box-shadow: 0 0 3px rgba(0,0,0,0.5); margin:3px; }
</style>
<body>
<script>
	
var add_card_to_body = function() {
	document.body.appendChild(this.render);
}
	
var cards_rendered = then();
var load_fonts = fonts();
var load_glyphs = glyphs();

var arial = load_fonts.add({ face: "Arial", size: 48,
	top: 0, hanging: 9, middle: 27, alphabetic: 43, ideographic: 53, bottom: 53 });
var times = load_fonts.add({ face: "Times New Roman", size: 48,
	top: 0, hanging: 9, middle: 27, alphabetic: 43, ideographic: 53, bottom: 53 });
var meddon = load_fonts.add({ face: "Meddon", size: 48,
	top: 0, hanging: 14, middle: 51, alphabetic: 67, ideographic: 101, bottom: 101 });
var griffy = load_fonts.add({ "face":"Griffy","size":48,"bold":false,"italic":false,"top":0,"hanging":10,"middle":33,"alphabetic":46,"ideographic":65,"bottom":65 });

var glyphs = {
	life: load_glyphs.add("â™¥",true,"48px Arial",{"x":14.3,"y":0.5},16.289720109627417,"#ff4747",0,1,1),
	combat: load_glyphs.add("âš”",true,"48px Arial",{"x":18.25,"y":-0.7},21.874394758541317,"#6b6b6b",0,1,1),
	item: load_glyphs.add("ðŸ—ƒ",true,"48px Arial",{"x":23.827499999999993,"y":3.663499999999999},20.799352625141964,"#000000",0,1,1)
};

var cards = [];

var card_size = { width: 250, height: 350, scale: 3 };

function render_glyph(ctx, char, x, y) {
	ctx.shadow("white", 60); ctx.strokeStyle = colour.setAlpha("white", 0.8); ctx.lineWidth = 0.5;
	ctx.strokeText(char, x, y);
	
	ctx.shadow("white", 0);
	ctx.fillText(char, x, y);
}
function render_stat(ctx, text, x, y, max_width) {
	ctx.shadow("white", 60); ctx.strokeStyle = "white"; ctx.lineWidth = 1;
	ctx.strokeText(text, x, y);
	
	ctx.shadow();
	ctx.fillText(text, x, y);
}
function render_title(ctx, text, x, y, max_width) {
	ctx.shadow("white", 60); ctx.strokeStyle = "white"; ctx.lineWidth = 2;
	ctx.strokeText(text, x, y);
	ctx.shadow();
	ctx.fillText(text, x, y);
}

var resources = [
	{ resource: "food" },
	{ resource: "water" },
	{ resource: "wood" },
	{ resource: "stone" },
].map(function(c) {
	var canvas = make_canvas(card_size, "white"), ctx = canvas.context;
	embiggenner(canvas, card_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();

	var _images = images();
	var icon = _images.add("test-images/icons/" + c.resource + ".png");
	var square = _images.add("test-images/square-black.png");
	
	var centre = { x: "middle", y: "middle" };
	var rcap = c.resource[0].toUpperCase() + c.resource.substr(1);
	
	then([_images, fonts]).then(function() {
		canvas.context.sub(function() {
			var shadow_colour = colour("black");
			shadow_colour.a = 0.4;
			
			ctx.shadow(shadow_colour, 50);
			
			var iscale = 0.07, icentre = 40;
			icon.render(canvas, { position: { x: icentre, y: icentre }, align: centre, scale: iscale, lighten: "white" });
			icon.render(canvas, { position: { x: card_size.width - icentre, y: card_size.height - icentre }, align: centre, scale: iscale, rotate: 180, lighten: "white" });
		});
		
		icon.render(canvas, { position: canvas.centre, align: centre, scale: 0.28 });
		
		complete();
	});
	
	return { name: rcap + " - Resource", description: "Used to build buildings, activate items, and distract monsters",
		render: canvas, size: card_size, hidden: null };
});
cards.push.apply(cards, resources);

var monsters = [
	{ name: "Fire Wyrm", health: 1, combat: 5, loot: 3,
		effect: "Only razes buildings.\n{water}: prevent the monster from razing 1 building." },
	{ name: "Dragon", health: 5, combat: 2, loot: 1,
		effect: "{stone} does not reduce combat." },
	{ name: "Giant", health: 3, combat: 5, loot: 6,
		effect: "Destroys a building instead of razing it." },
	{ name: "Hydra", health: 5, combat: 4, loot: 3,
		effect: "+1{health} every turn." }
].map(function(c) {
	var canvas = make_canvas(card_size, "white"), ctx = canvas.context;
	embiggenner(canvas, card_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();
	
	var load_images = images();
	var image = load_images.add("test-images/monsters/" + c.name.toLowerCase().replace(/ /g, "-") + ".png");
	
	then([load_glyphs, load_images]).then(function() {
		image.render(canvas, { scale: "no stretch" });
		
		// meddon.render(ctx, c.name, 170, 185, null, "middle middle", 0.48, render_title);
		meddon.render(ctx, c.name, 95, 187, null, "middle left", 0.48, render_title);
		
		glyphs.life.render(ctx, 30, 185, 20, null, null, render_glyph);
		arial.render(ctx, c.health, 30, 185, null, "middle middle", 0.7, render_stat);
		
		glyphs.combat.render(ctx, 70, 185, 20, null, null, render_glyph);
		arial.render(ctx, c.combat, 70, 185, null, "middle middle", 0.7, render_stat);
		
		glyphs.item.render(ctx, 205, 320, 25, null, null, render_glyph);
		arial.render(ctx, c.loot, 225, 320, null, "middle middle", 0.9, render_stat);
	});
	
	complete();
});

cards_rendered.then(function() {
	console.log("cards rendered");
	cards.forEach(function(c) {
		console.log("cards");
	});
});
	
// var c = card({ title: "blah" }, ).then(add_card_to_body);

function embiggenner(canvas, size) {
	canvas.style.width = size.width + "px";
	canvas.onclick = function() {
		canvas.embiggen = !canvas.embiggen;
		
		if (canvas.embiggen) {
			canvas.style.left = canvas.offsetLeft + "px";
			canvas.style.top = canvas.offsetTop + "px";
			canvas.style.position = "absolute";
			canvas.style.width = "";
			canvas.style.borderRadius = "30px";
		}
		else {
			canvas.style.position = "";
			canvas.style.width = size.width + "px";
			canvas.style.borderRadius = "";
		}
	};
	
	canvas.style.width = size.width + "px";
}


</script>
<script src="http://localhost:35729/livereload.js"></script>