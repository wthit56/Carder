<!doctype html><meta charset="utf-8" />
<script src="then.js"></script>
<script src="make_canvas.js"></script>
<script src="simple_transform.js"></script>
<script src="images.js"></script>
<script src="fonts.js"></script>
<script src="colour.js"></script>
<script src="glyphs.js"></script>
<script src="cardsheet.js"></script>
<script src="cs_from_cards.js"></script>
<script src="textbox-v3.1.js"></script>
<script src="game_decks.js"></script>
<script src="embiggenner.js"></script>
<script src="generate_tts.js"></script>
<style>
	canvas { box-shadow: 0 0 3px rgba(0,0,0,0.5); margin:3px; }
	.cardsheet { text-align:center; display:inline-block; padding:0.5em; }
	.cardsheet:hover { background:#eee; }
		.cardsheet input { }
	#generate { display:inline-block; }
	.json { display:inline-block; }
		.json textarea { width:100%; height:10em; }
	.field.folder { padding: 0.2em 0; }
</style>
<body>
<script>
	
var cards_rendered = then();
var load_fonts = fonts();
var load_glyphs = glyphs();

var arial = load_fonts.add({ face: "Arial", size: 48,
	top: 0, hanging: 9, middle: 27, alphabetic: 43, ideographic: 53, bottom: 53 });
var times = load_fonts.add({ face: "Times New Roman", size: 48,
	top: 0, hanging: 9, middle: 27, alphabetic: 43, ideographic: 53, bottom: 53 });
var meddon = load_fonts.add({ face: "Meddon", size: 48,
	top: 0, hanging: 14, middle: 51, alphabetic: 67, ideographic: 101, bottom: 101 });
var griffy = load_fonts.add({ "face":"Griffy","size":48,"bold":false,"italic":false,"top":0,"hanging":10,"middle":33,"alphabetic":46,"ideographic":65,"bottom":65 });

var glyphDB = {
	life: load_glyphs.add("‚ô•",true,"48px Arial",{"x":14.3,"y":0.5},16.289720109627417,"#ff4747",0,1,1),
	combat: load_glyphs.add("‚öî",true,"48px Arial",{"x":18.25,"y":-0.7},21.874394758541317,"#6b6b6b",0,1,1),
	item: load_glyphs.add("üóÉ",true,"48px Arial",{"x":23.827499999999993,"y":3.663499999999999},20.799352625141964,"#000000",0,1,1),
	
	water: load_glyphs.add("S",true,"48px Wingdings",{"x":15.6,"y":-0.5817012011995146},18.5,"#64d9e6",0,1,1),
	food: load_glyphs.add("üçû",true,"48px Arial",{"x":23.84887249999999,"y":-2.428463701199515},23.036465384403325,"#d99413",0,1,1),
	stone: load_glyphs.add("‚ñà",true,"48px Arial",{"x":17,"y":1.5},34.72202344778929,"#919191",90,1,1),
	wood: load_glyphs.add("‚ñà",true,"48px Arial",{"x":17,"y":1.5},34.72202344778929,"#ac7333",48.12201981426726,0.58,1)
};

var card_size = { width: 250, height: 350, scale: 3 };

var image_preload = images();
image_preload.then(cards_rendered.add());

var hidden = image_preload.add("test-images/hidden.png"); hidden.id = "hidden-card";
var back = image_preload.add("test-images/back.png"); {
	back.id = "back-card";
	back.preview_width = card_size.width;
}

function render_glyph(ctx, char, x, y) {
	ctx.shadow("white", 60); ctx.strokeStyle = colour.setAlpha("white", 0.8); ctx.lineWidth = 0.5;
	ctx.strokeText(char, x, y);
	
	ctx.shadow("white", 0);
	ctx.fillText(char, x, y);
}
function render_stat(ctx, text, x, y, max_width) {
	ctx.shadow("white", 60); ctx.strokeStyle = "white"; ctx.lineWidth = 1;
	ctx.strokeText(text, x, y);
	
	ctx.shadow();
	ctx.fillText(text, x, y);
}
function render_title(ctx, text, x, y, max_width) {
	ctx.shadow("white", 60); ctx.strokeStyle = "white"; ctx.lineWidth = 2;
	ctx.strokeText(text, x, y);
	ctx.shadow();
	ctx.fillText(text, x, y);
}

var decks = game_decks("Foragerv2");

var foraging_deck = decks.add("Foraging", null, { facedown: true });
var resources = [
	{ resource: "food" },
	{ resource: "water" },
	{ resource: "wood" },
	{ resource: "stone" },
].map(function(c) {
	var canvas = make_canvas(card_size, "white"), ctx = canvas.context;
	embiggenner(canvas, card_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();

	var _images = images();
	var icon = _images.add("test-images/icons/" + c.resource + ".png");
	var square = _images.add("test-images/square-black.png");
	
	var centre = { x: "middle", y: "middle" };
	var rcap = c.resource[0].toUpperCase() + c.resource.substr(1);
	
	then([_images, fonts]).then(function() {
		canvas.context.sub(function() {
			var shadow_colour = colour("black");
			shadow_colour.a = 0.4;
			
			ctx.shadow(shadow_colour, 50);
			
			var iscale = 0.07, icentre = 40;
			icon.render(canvas, { position: { x: icentre, y: icentre }, align: centre, scale: iscale, lighten: "white" });
			icon.render(canvas, { position: { x: card_size.width - icentre, y: card_size.height - icentre }, align: centre, scale: iscale, rotate: 180, lighten: "white" });
		});
		
		icon.render(canvas, { position: canvas.centre, align: centre, scale: 0.28 });
		
		complete();
	});
	
	var proxy = { name: rcap + " - Resource", description: "Used to build buildings, activate items, and distract monsters",
		render: canvas, size: card_size, hidden: hidden, back: back };
	decks.add(proxy.name, proxy.description).add(10, proxy);
	foraging_deck.add(1, proxy);
	return proxy;
});
// cards.push.apply(cards, resources);

var effect_parsers = [
	{ type: "glyph", find: /\{([^}]+)}/, from: "$1", colour: "black" },
	{ type: "break", find: /\n/ },
	{ type: "text", font: arial, bold: true, scale: 0.4, find: /\*([^\r\n\*]+)\*/, from: "$1" }
];

var time_boss_deck = decks.add("Time: Bosses", "Shuffle, draw 1 to start the Time deck", { facedown: true, shuffled: true }),
	time_deck = decks.add("Time: With Monsters!", "Shuffle, add on top of the Time deck", { facedown: true, shuffled: true }),
	time_intro_deck = decks.add("Time: Intro Cards", "Add 3 per player on top of the time deck", { facedown: true });

var time = (function() {
	var canvas = make_canvas(card_size, "white"), ctx = canvas.context;
	embiggenner(canvas, card_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();
	var load_images = images();
	
	var time = load_images.add("test-images/time.jpg");
	load_images.then(function() {
		time.render(canvas, {
			position: canvas.centre,
			align: { x: "middle", y: "middle" },
			scale: 0.25
		});
		complete();
	});
	
	var proxy = { name: "Time passes...", render: canvas, size: card_size, hidden: hidden, back: back };
	time_intro_deck.add(8, proxy);
	time_deck.add(30, proxy);
	return proxy;
})();

var monsters = [
	{ name: "Fire Wyrm", health: 1, combat: 5, loot: 3,
		effect: "Only razes buildings.\n{water}: prevent the monster from razing 1 building." },
	{ name: "Dragon", health: 5, combat: 2, loot: 1,
		effect: "{stone} does not reduce combat." },
	{ name: "Giant", health: 3, combat: 5, loot: 6,
		effect: "Destroys a building instead of razing it." },
	{ name: "Hydra", health: 5, combat: 4, loot: 3,
		effect: "+1{life} every turn." },
	{ name: "Fire Wyrm", health: 3, combat: 5, loot: 6,
		effect: "[TEST!!!] Destroys {life} a building {combat} instead of {item} razing it." }
].map(function(c) {
	var proxy = monster_render(c);
	time_deck.add(1, proxy);
});
time_boss_deck.add(3, monster_render({ name: "Thendar", health: 8, combat: 3, effect: "???" }));
function monster_render(c) {
	var canvas = make_canvas(card_size, "white"), ctx = canvas.context;
	embiggenner(canvas, card_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();
	
	var load_images = images();
	var image = load_images.add("test-images/monsters/" + c.name.toLowerCase().replace(/ /g, "-") + ".png");
	
	then([load_glyphs, load_images]).then(function() {
		image.render(canvas, { scale: "no stretch" });
		
		meddon.render(ctx, c.name, 15, 187, null, "middle left", 0.48, render_title);
		
		glyphDB.life.render(ctx, 220, 185, 20, null, null, render_glyph);
		arial.render(ctx, c.health, 220, 185, null, "middle middle", 0.7, render_stat);
		
		glyphDB.combat.render(ctx, 180, 185, 20, null, null, render_glyph);
		arial.render(ctx, c.combat, 180, 185, null, "middle middle", 0.7, render_stat);
		
		if (c.loot) {
			glyphDB.item.render(ctx, 205, 320, 25, null, null, render_glyph);
			arial.render(ctx, c.loot, 225, 320, null, "middle middle", 0.9, render_stat);
		}
		
		var effect_box = { from: { x: 20, y: 210 }, to: { x: card_size.width - 20, y: card_size.height - 20 } };
		if (false) { // debug
			ctx.save(); {
				var debug = colour("red");
				debug.alpha = 0.5;
				ctx.fillStyle = debug;
				
				ctx.fillRect(effect_box.from.x, effect_box.from.y, effect_box.to.x - effect_box.from.x, effect_box.to.y - effect_box.from.y);
			} ctx.restore();
		}
		
		textbox(effect_box).write(ctx, textbox.parse(c.effect, effect_parsers, glyphDB), arial, 0.4, 1, 3);
		
		complete();
	});
	
	return { name: c.name + " - Monster [" + c.health + " health, " + c.combat + " combat" + (c.loot ? ", " + c.loot + " loot" : "") + "]", description: c.effect,
		render: canvas, size: card_size, hidden: hidden, back: back };
}

var tile_size = { width: 250, height: 250, scale: 3 };
var locations_back = (function() {
	var complete = cards_rendered.add();
	
	var canvas = make_canvas(tile_size), ctx = canvas.context;
	embiggenner(canvas, tile_size);
	canvas.preview_width = tile_size.width;
	document.body.appendChild(canvas);
	
	ctx.fillStyle = "#204120";
	ctx.fillRect(0, 0, tile_size.width, tile_size.height);
	
	var load_images = images();
	var forest = load_images.add("test-images/tile-over.png");
	load_images.then(function() {
		forest.render(canvas, { scale: "no stretch" });
		// forest.render(canvas);
		complete();
	});
	
	return canvas;
})();

var locations_deck = decks.add("Locations", null, { facedown: true, shuffled: true });
["Food", "Water", "Wood", "Stone"].forEach(function(c) {
	locations_deck.add(2, {
		name: c + " - Location", description: "Forage for more " + c,
		render: render_tile(c), size: tile_size, back: locations_back
	});
});

(function() {
	var render = render_tile("Town");
	decks.add("Town", "Place in the centre of the table").add(1, {
		name: "Town - Location", description: "The place to lay your head.\nThe place to defend with your life.",
		render: render, size: tile_size, back: render
	});
})();

function render_tile(c) {
	var canvas = make_canvas(tile_size), ctx = canvas.context;
	embiggenner(canvas, tile_size);
	document.body.appendChild(canvas);
	
	var complete = cards_rendered.add();
	var load_images = images();
	var icon = load_images.add("test-images/icons/" + c.toLowerCase() + ".png");
	var forest = load_images.add("test-images/tile-over.png");
	
	load_images.then(function() {
		ctx.fillStyle = "#a0d6a0";
		ctx.fillRect(0, 0, tile_size.width, tile_size.height);
		
		icon.render(canvas, { position: canvas.centre, align: { x: "middle", y: "middle" }, scale: 0.22 });
		forest.render(canvas, { scale: "no stretch" });
		
		complete();
	});

	return canvas;
}

cards_rendered.then(function() {
	generate_tts(decks);
});

</script>
<script src="http://localhost:35729/livereload.js"></script>